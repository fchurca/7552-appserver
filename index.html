<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>PyAppServer: Página principal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PyAppServer
   </div>
   <div id="projectbrief">Application Server en Python para Taller de Prog 2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generado por Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Página&#160;principal</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Clases</span></a></li>
      <li><a href="files.html"><span>Archivos</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Buscar" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Todo</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Clases</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Archivos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Funciones</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PyAppServer Documentación</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>An application server for Llevame written in Python</p>
<ul>
<li><a href="https://travis-ci.org/fchurca/7552-appserver">![Build Status](https://travis-ci.org/fchurca/7552-appserver.svg?branch=master)</a></li>
<li><a href="https://coveralls.io/github/fchurca/7552-appserver">![Coverage Status](https://coveralls.io/repos/github/fchurca/7552-appserver/badge.svg)</a></li>
</ul>
<h2>Associated Acts</h2>
<ul>
<li>Heroku Dashboard: <a href="https://dashboard.heroku.com/teams/tallerii-7552-20172-g3">https://dashboard.heroku.com/teams/tallerii-7552-20172-g3</a> (you are logged in, aren't you?)</li>
<li>Master repositories<ul>
<li>Android client: <a href="https://github.com/smaraggi/HG-android-client/network">https://github.com/smaraggi/HG-android-client/network</a></li>
<li>AppServer (this repo): <a href="https://github.com/fchurca/7552-appserver">https://github.com/fchurca/7552-appserver</a></li>
<li>SharedServer: <a href="https://github.com/florrup/sharedserver">https://github.com/florrup/sharedserver</a></li>
</ul>
</li>
</ul>
<h2>Useful links</h2>
<ul>
<li>Subject site: <a href="http://7552.fi.uba.ar/">http://7552.fi.uba.ar/</a></li>
<li>Assignment: <a href="https://github.com/taller-de-programacion-2/taller-de-programacion-2.github.io/blob/master/trabajo-practico/enunciados/2017/2/llevame.md">https://github.com/taller-de-programacion-2/taller-de-programacion-2.github.io/blob/master/trabajo-practico/enunciados/2017/2/llevame.md</a></li>
</ul>
<h2>Interfaces</h2>
<ul>
<li>An Android client will connect to this server</li>
<li>A MongoDB instance for persistence. Means for configuring a development instance are included in this repo.</li>
<li>SharedServer for storing user data, final trip data, and all that jazz.</li>
<li>Firebase Cloud Messaging for pushing notifications to Android clients.</li>
<li>USIG for determining street addresses from user locations inside Buenos Aires City.</li>
</ul>
<h2>Dependencies</h2>
<p>For a Docker server on Debian: <a href="https://docs.docker.com/engine/installation/linux/docker-ce/debian/">https://docs.docker.com/engine/installation/linux/docker-ce/debian/</a></p>
<h2>Building Docker Image</h2>
<p>From the root of the project, where the build scripts are located, execute: ``` ./appserver.build.sh ``` This script builds a Docker image from the Dockerfile in the root of the project's tree. The image will be called fiuba/appserver:dev, and this is the name that the execution scripts will later use.</p>
<h2>Deploying Containers for Local Development</h2>
<p>First create a Docker network for Mongo and server containers: ``` docker network create taller ``` Launch now a MongoDB container: ``` ./mongo.run.sh ``` After Mongo is up, run in another terminal: ``` ./appserver.run.sh ```</p>
<p>The script launches the image fiuba/appserver:dev inside a container. The container is configured as follows:</p><ul>
<li>Port 8080 of the container is mapped to port 8080 of the host</li>
<li>AppServer container is placed inside network <code>taller</code>, with name <code>appserver.taller</code></li>
<li>The project's source code directory in the host is mapped to the directory where gunicorn looks for the application scripts. Since gunicorn is executed with live reload, local live edits to the application code will be instantly reloaded by gunicorn without having to build the image and reload the container once again.</li>
<li>MongoDB container is placed inside network <code>taller</code>, with name <code>mongodb.taller</code></li>
<li>By default, the container will try to contact the SharedServer at <code>sharedserver.taller</code> More elaborate setups may arise. In that case, refer to the following sections.</li>
</ul>
<h2>Deploying to Heroku</h2>
<p>To deploy to Heroku simply push the contents of the source directory into the Heroku repository. For details and specifics, goto <a href="https://devcenter.heroku.com/articles/git">https://devcenter.heroku.com/articles/git</a> We have found it useful to use pipelines and Github Sync: <a href="https://devcenter.heroku.com/articles/pipelines">https://devcenter.heroku.com/articles/pipelines</a></p>
<h2>Configuration</h2>
<p>The following environment variables need to be set:</p><ul>
<li><code>APPSERVER_CFG</code> Location for configuration files, relative to the root of the project.</li>
<li><code>SHAREDSERVER_URL</code> SharedServer URL (default, variable name in <code>$APPSERVER_CFG/sharedserver.ini</code>)</li>
<li><code>SHAREDSERVER_TOKEN</code> Initial SharedServer token</li>
<li><code>MONGODB_URI</code> MongoDB URI (default, variable name in <code>$APPSERVER_CFG/mongo.ini</code>)</li>
<li><code>FCM_API_KEY</code> Firebase Cloud Messaging key</li>
</ul>
<h3>SharedServer</h3>
<p>The variable that defines the URL of the SharedServer instance is defined in <code>$APPSERVER_CFG/sharedserver.ini</code>: ``` [Connection] sharedservervar=SHAREDSERVER_URL ``` Alternatively, the URL itself can be defined in the configuration file: ``` [Connection] url=<a href="http://sharedserver.taller:5000/api/">http://sharedserver.taller:5000/api/</a> ``<code> In both cases, the token will be defined as the environment variable</code>SHAREDSERVER_TOKEN`.</p>
<h3>MongoDB</h3>
<p>The variable that defines the connection string to some MongoDB instance can be defined in <code>$APPSERVER_CFG/mongo.ini</code>: ``` [Connection] mongovar=MONGODB_URI database=db ``<code> Then, in this case, the connection string is equal to the value of the variable</code>MONGODB_URI<code>. Alternatively, the connection string can be placed directly inside the configuration file as follows: </code>`` [Connection] uri=&lt;connection string&gt;=""&gt; database=db ``` For security reasons, however, this may not be desirable.</p>
<h3>Logging</h3>
<p>Logging is configured in <code>$APPSERVER_CFG/mongo.ini</code>. Example: ``` [Logging] level=DEBUG format=[%%(asctime)s] [%%(process)d] [%%(levelname)s] %%(name)s - %%(message)s ``` For more information regarding Python 3 logging and logging formats, see: <a href="https://docs.python.org/3/library/logging.html">https://docs.python.org/3/library/logging.html</a></p>
<h2>Building Redistributable Package</h2>
<p>First install Python dependency setuptools: ``` pip install setuptools ``` Then execute from the root of the project directory ``` python setup.py sdist ``` This should generate a redistributable archive file under a newly created dist directory.</p>
<h2>Installing and Executing Redistributable Package</h2>
<p>To install the package, execute the following: ``` pip install &lt;path to="" archive="" file&gt;=""&gt; ``` Application server can then be executed using gunicorn: ``` pip install gunicorn gunicorn &ndash;workers 4 appserver:app ```</p>
<h2>Future improvements</h2>
<p>In order to make this daemon bulletproof, several improvements can be made. Namely:</p><ul>
<li>Use of USIG can be replaced by calls to Google or OpenStreetMap in order to infer street addresses outside of Buenos Aires.</li>
<li>A back office module can be implemented, or an administration API to be exposed to the SharedServer backoffice.</li>
<li>The position of the passenger is tracked during the trip in order to calculate distance. However, the raw positions as informed by the passenger are used. This can result in unexpectedly high costs if the positions jump around. The datapoints can be smoothed out with LOESS and outlier filtering, either by local variance or by position error. Or with LOWESS weighted by (π/2)-arctan(error). Or some nonlinear regression algorithm or other. Or something.</li>
<li>The deployment methods described use a static number of worker processes. Means to ensure an on-demand elastic deployment of daemons can be realised.</li>
<li>Even more testing. There's never enough testing.</li>
</ul>
<h2>Generating Doxygen Documentation</h2>
<p>``` apt-get install doxygen graphviz doxygen ``` HTML documentation will be placed inside the docs/generated directory.</p>
<h2>Troubleshooting</h2>
<h3>Mongo complains about <code>No space left on device: "/data/db/journal"</code></h3>
<p>Dangling stale volumes may still be laying around after an untidy exit, such as a power loss. The following commands for listing and removing volumes may require root permissions. In that case, use <code>su</code> or <code>sudo</code> with the usual precautions. You know what you doing. ``` </p><h1>list</h1>
<p>docker volume ls -qf dangling=true </p><h1>remove</h1>
<p>docker volume rm $(docker volume ls -qf dangling=true) ``` </p><h3>An invisible man sitting in your bed</h3>
<p>Call <code>555-2368</code> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generado por
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
